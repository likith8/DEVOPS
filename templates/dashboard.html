{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2 class="my-4 text-center">Task Dashboard</h2>

    <!-- Filter by Category -->
    <form method="GET" action="{{ url_for('dashboard') }}" class="mb-4">
        <label for="category" class="form-label">Filter by Category:</label>
        <select name="category" id="category" class="form-select" onchange="this.form.submit()">
            <option value="">All Categories</option>
            <option value="Work" {% if selected_category == 'Work' %}selected{% endif %}>Work</option>
            <option value="Personal" {% if selected_category == 'Personal' %}selected{% endif %}>Personal</option>
            <option value="Others" {% if selected_category == 'Others' %}selected{% endif %}>Others</option>
        </select>
    </form>

    <!-- Completion Percentage -->
    <h4 class="text-center">Overall Completion: {{ completion_percentage }}%</h4>

    <!-- Add Task Form -->
    <h4 class="mt-5">Add New Task</h4>
    <form method="POST" action="{{ url_for('dashboard') }}">
        <div class="mb-3">
            <label for="task" class="form-label">Task</label>
            <input type="text" class="form-control" id="task" name="task" required>
        </div>
        <div class="mb-3">
            <label for="end_time" class="form-label">End Time</label>
            <input type="datetime-local" class="form-control" id="end_time" name="end_time">
        </div>
        <div class="mb-3">
            <label for="priority" class="form-label">Priority</label>
            <select class="form-select" id="priority" name="priority">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="category" class="form-label">Category</label>
            <select class="form-select" id="category" name="category" required>
                <option value="Work">Work</option>
                <option value="Personal">Personal</option>
                <option value="Others">Others</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="tags" class="form-label">Tags</label>
            <input type="text" class="form-control" id="tags" name="tags" placeholder="Comma separated tags">
        </div>
        <div class="mb-3">
            <label for="recurrence" class="form-label">Recurrence</label>
            <select class="form-select" id="recurrence" name="recurrence">
                <option value="none" selected>None</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
            </select>
        </div>

        <!-- Subtasks Section -->
        <div class="mb-3">
            <label class="form-label">Subtasks</label>
            <div id="subtasks-container">
                <input type="text" class="form-control mb-2" name="subtasks[]" placeholder="Enter a subtask">
            </div>
            <button type="button" class="btn btn-secondary" onclick="addSubtask()">Add Another Subtask</button>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Add Task</button>
    </form>

    <!-- Task List -->
    <div class="mt-4">
        <h4>Task List</h4>
        {% for task in tasks %}
        <div class="task-card mb-4 p-3 border rounded shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ task['task'] }}</h4>
                <span class="badge {% if task['priority'] == 'High' %}bg-danger{% elif task['priority'] == 'Medium' %}bg-warning{% else %}bg-success{% endif %}">
                    {{ task['priority'] }}
                </span>
            </div>
            <p><strong>Category:</strong> {{ task['category'] }}</p>
            <p><strong>Start Time:</strong> {{ task['start_time_str'] }}</p>
            <p><strong>End Time:</strong> {{ task['end_time_str'] }}</p>
            <p><strong>Owner:</strong> {{ task['owner'] }}</p>

            {% if task['assigned_to'] %}
                <p><strong>Assigned to:</strong> {{ task['assigned_to'] | join(', ') }}</p>
            {% endif %}

            {% if task['tags'] %}
                <p><strong>Tags:</strong> {{ task['tags'] | join(', ') }}</p>
            {% endif %}

            {% if task['subtasks'] %}
                <h5>Subtasks</h5>
                <ul>
                    {% for subtask in task['subtasks'] %}
                        <li>
                            <input type="checkbox" {% if subtask['completed'] %}checked{% endif %}
                                   onchange="window.location.href='{{ url_for('complete_subtask', subtask_id=subtask['_id']) }}'">
                            {{ subtask['text'] }}
                            <a href="{{ url_for('delete_subtask', subtask_id=subtask['_id']) }}">Delete</a>
                        </li>
                    {% endfor %}
                </ul>

                {% set completed_subtasks = task['subtasks'] | selectattr('completed', 'equalto', true) | list %}
                {% set progress_percentage = (completed_subtasks | length) / (task['subtasks'] | length) * 100 %}
                <div class="progress mb-2">
                    <div class="progress-bar bg-info" role="progressbar"
                         style="width: {{ progress_percentage }}%"
                         aria-valuenow="{{ progress_percentage }}"
                         aria-valuemin="0" aria-valuemax="100">
                         {{ progress_percentage | round(0) }}%
                    </div>
                </div>
            {% endif %}

            <form action="{{ url_for('add_subtask', task_id=task['_id']) }}" method="post">
                <input type="text" name="subtask" placeholder="Add a subtask" class="form-control mb-2">
                <button type="submit" class="btn btn-primary btn-sm">Add Subtask</button>
            </form>

            <div class="mt-3">
                <a href="{{ url_for('complete_task', task_id=task['_id']) }}" class="btn btn-success btn-sm">Mark as Completed</a>
                <a href="{{ url_for('delete_task', task_id=task['_id']) }}" class="btn btn-danger btn-sm">Delete Task</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function addSubtask() {
        const container = document.getElementById('subtasks-container');
        const input = document.createElement('input');
        input.type = 'text';
        input.classList.add('form-control', 'mb-2');
        input.name = 'subtasks[]';
        input.placeholder = 'Enter a subtask';
        container.appendChild(input);
    }
</script>

{% endblock %}
